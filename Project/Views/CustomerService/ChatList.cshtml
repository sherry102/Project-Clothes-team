@model IEnumerable<Project.Models.Tcservice>
@{
    ViewData["Title"] = "ChatList";
}
<h1>客服</h1>

<div class="chat-container">
    <div class="chat-header">
        <h3>聊天室</h3>
    </div>
    <div class="chat-content" id="Content">
    </div>
    <div class="chat-footer">
        <h4>個人 ID: <span id="SelfID"></span></h4>
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="message" placeholder="輸入訊息...">
            <input type="text" class="form-control" id="sendToID" placeholder="指定 ID">
            <button type="button" class="btn btn-primary" id="sendButton">傳送訊息</button>
        </div>
    </div>
    <div class="chat-sidebar">
        <h4>連線 ID 列表</h4>
        <ul class="list-group" id="IDList">
        </ul>
    </div>
</div>

@section styles {
    <style>
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            background-color: #007bff;
            color: white;
            padding: 10px;
            text-align: center;
        }

        .chat-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: #f1f1f1;
        }

        .chat-footer {
            padding: 10px;
            background-color: #fff;
            border-top: 1px solid #ddd;
        }

        .chat-sidebar {
            padding: 10px;
            background-color: #fff;
            border-left: 1px solid #ddd;
        }

        .list-group-item {
            margin-bottom: 5px;
        }
    </style>
}

@section scripts {
    <script src="~/js/signalr/dist/browser/signalr.js"></script>
    <script>
        var connection = new signalR.HubConnectionBuilder().withUrl("/ChatHub").build();

        //與Server建立連線
        connection.start().then(function () {
            console.log("Hub 連線完成");
        }).catch(function (err) {
            alert('連線錯誤: ' + err.toString());
        });

        // 更新連線 ID 列表事件
        connection.on("UpdList", function (jsonList) {
            var list = JSON.parse(jsonList);
            $("#IDList li").remove();
            for(i=0; i<list.length; i++)
            {
                $("#IDList").append($("<li></li>").attr("class", "list-group-item").text(list[i]));
            }
        });

        // 更新用戶個人連線 ID 事件
        connection.on("UpdSelfID", function (id) {
            $('#SelfID').html(id);
        });

        // 更新聊天內容事件
        connection.on("UpdContent", function (msg) {
            $("#Content").append($("<div></div>").attr("class", "list-group-item").text(msg));
        });

        //傳送訊息
        $('#sendButton').on('click', function() {
            let selfID = $('#SelfID').html();
            let message = $('#message').val();
            let sendToID = $('#sendToID').val();
            connection.invoke("SendMessage", selfID, message, sendToID).catch(function (err) {
                alert('傳送錯誤: ' + err.toString());
            });
        });
    </script>
}