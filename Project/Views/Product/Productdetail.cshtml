@model Project.Models.CProductWrap

@{
    Layout = "~/Views/Shared/Front_Layout.cshtml";
}
@section Styles {
    <link href="https://fonts.googleapis.com/css2?family=Cactus+Classical+Serif&family=LXGW+WenKai+TC&family=Liu+Jian+Mao+Cao&family=Long+Cang&family=Ma+Shan+Zheng&family=ZCOOL+QingKe+HuangYou&display=swap" rel="stylesheet">
    <style>
        .btn-side {
            position: absolute;
            margin: 2px;
            background-color: #8891a3c7 !important;
            border: none !important;
            color: white !important;
            width: 60px;
            height: 35px;
            border-radius: 10px !important;
        }

            .btn-side:hover {
                background-color: #8a8282c7 !important;
                border: 1px solid #8891a3c7 !important;
            }

        .product-item {
            text-align: center;
        }


        .sticky-sidebar {
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto; /* 確保如果內容過長，仍可在內部滾動 */
        }

            .sticky-sidebar::-webkit-scrollbar {
                display: none;
            }

        .product-images img {
            width: 100%;
            height: auto;
            object-fit: cover;
            margin: 0;
            padding: 0;
        }

        .product-images .col-6 {
            padding: 0; /* 移除 Bootstrap 預設間距 */
        }
    </style>
}
<!-- breadcrumb 麵包屑 -->
<nav aria-label="breadcrumb" class="p-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="~/FrontHome/FrontIndex" class="text-decoration-none">首頁</a></li>
        <li class="breadcrumb-item active" aria-current="page"><a href="~/Product/ProductList" class="text-decoration-none">商品列表</a></li>
        <li class="breadcrumb-item active" aria-current="page">商品介紹</li>
    </ol>
</nav>
<div class="container">
    <div class="row">
        <!-- 左側圖片區-->
        <div class="col-md-8">
            <div class="row product-images">
                <div class="col-6">
                    <img src="~/Images/@Html.DisplayFor(model => model.Pphoto)" alt="">
                </div>
                @{
                    int count = 0;
                    @foreach (var image in Model.Images)
                    {
                        count++;
                        <div class="col-6">
                            <img src="~/Images/@image" alt="商品圖片">
                        </div>
                    }
                }
            </div>
        </div>

        <!-- 右側固定欄 -->
        <div class="col-md-4 sticky-sidebar p-3 ">
            <div class="fs-3 ms-4"> @Html.DisplayFor(model => model.Pname) </div>
            <div class="fs-3 mt-5 ms-4">NT$ @Html.DisplayFor(model => model.Pprice) </div>
            <div class="fs-5 mt-5 ms-4">@Html.DisplayFor(model => model.Pdescription) </div>
            <div class="fs-5 ms-4">

                <div class="my-5">
                    @foreach (var color in Model.Colors)
                    {
                        // 計算該顏色的總庫存量
                        int totalStock = Model.StockMap
                        .Where(s => s.Key.StartsWith(color + "-")) // 找出這個顏色的所有尺寸
                        .Sum(s => s.Value); // 加總庫存數量

                        // 如果該顏色總庫存為 0，按鈕禁用
                        bool isOutOfStock = totalStock == 0;

                        <button type="button" class="btn btn-outline-dark"
                                value="@color"
                        @(isOutOfStock ? "disabled" : "")>
                            @color (@totalStock)
                        </button>
                    }
                <div class="my-5">
                        @foreach (var size in Model.Sizes)
                        {
                            bool hasStock = Model.StockMap.Any(s => s.Key.EndsWith(size) && s.Value > 0);
                            if (hasStock)
                            {
                                <button type="button" class="btn btn-outline-dark" value="@size">@size</button>
                            }
                        }
                </div>
                <div class="fs-5 mt-4">
                    <div class="input-group" style="max-width: 150px;">
                        <button class="btn btn-outline-secondary" type="button" onclick="decreaseQuantity()">-</button>
                        <input type="text" class="form-control text-center" value="1" id="quantity">
                        <button class="btn btn-outline-secondary" type="button" onclick="increaseQuantity()">+</button>
                    </div>
                    <button type="button" class="btn btn-outline-secondary mt-2"
                            onclick="addToCart('@Model.Pid', '@Model.Pname','@Model.Pphoto','@Model.Pprice')">
                        加入購物車
                    </button>

                    <button type="button" class="btn btn-outline-secondary mt-2"
                            onclick="addToFavorite('@Model.Pid', '@Model.Pname', '@Model.Pphoto', '@Model.Pprice')">
                        加入最愛
                    </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts
{
    <script>
         $(document).ready(function () {
            $(".color-btn").click(function () {
                var selectedColor = $(this).data("color");

                // 高亮選擇的顏色
                $(".color-btn").removeClass("active");
                $(this).addClass("active");

                // 顯示對應尺寸按鈕
                $(".size-btn").hide();
                $(".size-btn[data-color='" + selectedColor + "']").show();
            });
        });
        function increaseQuantity() {
          var quantity = document.getElementById("quantity");
          quantity.value = parseInt(quantity.value) + 1;
        }

        function decreaseQuantity() {
          var quantity = document.getElementById("quantity");
          if (parseInt(quantity.value) > 1) {
            quantity.value = parseInt(quantity.value) - 1;
          }
        }

        function addToCart(productId, productName, productPhoto, productPrice) {
            var quantity = parseInt(document.getElementById("quantity").value); // 取得目前輸入的數量
            $.ajax({
                url: '/AJAX/addToCart',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    PId: productId,
                    PName: productName,
                    PType:"女裝",
                    PCategory:"女裝",
                    PCount: quantity,// 使用者選擇的數量
                    PSize: "S",
                    PColor:"白",
                    CustomText0:"",
                    CustomText1: "",
                    CustomPhoto0: "",
                    CustomPhoto1: "",
                    Photo0: productPhoto,
                    Photo1: "",
                    PPrice:productPrice,
                }),
                success: function(response) {
                    alert(response); // 顯示伺服器回傳的訊息
                },
                error: function(xhr, status, error) {
                    console.error("加入購物車時發生錯誤: " + error);
                    alert("加入購物車失敗，請稍後再試！");
                }
            });
        }
         function addToFavorite(productId, productName, productPhoto, productPrice) {
            $.ajax({
                url: '/AJAX/PostFavorite',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    PId: productId,
                    PName: productName,
                    PPhoto: productPhoto,
                    PPrice: productPrice
                }),
                success: function(response) {
                    alert(response);
                },
                error: function(xhr, status, error) {
                    alert(err);
                }
            });
        }

    </script>
}

