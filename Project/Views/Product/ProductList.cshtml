@model List<Project.Models.CProductWrap>

@{
    Layout = "~/Views/Shared/Front_Layout.cshtml";
}
@section styles {
    <style>
        .card-body {
            position: relative;
            justify-content: space-between;
            font-size: 18px;
        }

        .favorite {
            font-size: 20px;
            position: absolute;
            top: 8px;
            right: 8px;
            color: gray !important;
        }

        .bi-heart-fill {
            color: indianred !important;
        }

    </style>
}

<!-- 麵包屑 -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb mt-3">
        <li class="breadcrumb-item"><a href="~/FrontHome/FrontIndex" class="text-decoration-none">首頁</a></li>
        <li class="breadcrumb-item active" aria-current="page">商品列表</li>
    </ol>
</nav>
<!-- 產品列表 -->
<div id="app">
    <div class="container mb-5 text-center">
        <div class="row">
            @if (!Model.Any(m => !m.PisHided))
            {
                <div class="col-12">
                    <p class="text-center mt-5">找不到符合條件的商品。</p>
                </div>
            }
            else
            {
                @foreach (var item in Model.Where(m => m.Pinventory != 0))
                {
                    <div class="col-12 col-md-6 col-xl-3">
                        <div class="card mb-3">
                            <i class="bi bi-heart favorite" data-id="@item.Pid" onclick="addToFavorite('@item.Pid', '@item.Pname', '@item.Pphoto', '@item.Pprice', this)"></i>
                            <a href="@Url.Action("ProductDetail",new { id = item.Pid })">
                 
                                <img src="~/images/@item.Pphoto" alt="" class="card-img-top" />
                            </a>
                            <div class="card-body">
                                <a href="@Url.Action("ProductDetail",new { id = item.Pid })">
                                    <div class="card-title mt-2 fw-bold ps-2" style="color:dimgray">@Html.DisplayFor(modelItem => item.Pname)</div>
                                </a>
                                <div class="card-text mt-1 ps-2 pb-2" style="color:black">NT$ @Html.DisplayFor(modelItem => item.Pprice)</div>
                                
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function () {
            // 取得使用者已收藏的商品 ID 並標記紅色
            $.ajax({
                url: "/Ajax/GetFavoriteID",
                type: "GET",
                success: function (favoriteIDs) {
                    favoriteIDs.forEach(function (pid) {
                        let heartIcon = $(`.favorite[data-id='${pid}']`);
                        heartIcon.removeClass("bi-heart").addClass("bi-heart-fill text-danger");
                    });
                },
                error: function () {
                    console.log("無法獲取收藏資料");
                }
            });
        });

        function addToFavorite(pid, pname, pphoto, pprice, element) {
            $.ajax({
                url: "/Ajax/PostFavorite",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    PId: pid,
                    PName: pname,
                    PPhoto: pphoto,
                    PPrice: pprice
                }),
                success: function (response) {
                    if (response === "請先登入會員") {
                        alert(response);
                    } else if (response === "已加入收藏" || response === "已移除收藏") {
                        toggleFavoriteUI(element);
                        alert(response);
                    } else {
                        alert("操作發生錯誤，請稍後再試");
                    }
                },
                error: function () {
                    alert("系統錯誤，請稍後再試！");
                }
            });
        }

        function toggleFavoriteUI(element) {
            let isFavorite = $(element).hasClass("bi-heart-fill");

            if (isFavorite) {
                $(element).removeClass("bi-heart-fill text-danger").addClass("bi-heart");
            } else {
                $(element).removeClass("bi-heart").addClass("bi-heart-fill text-danger");
            }
        }
    </script>

}
