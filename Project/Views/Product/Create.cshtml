@model Project.Models.CProductWrap

@{
    ViewData["Title"] = "Create";
}

<h4>新增商品</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Create" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="Pname" class="control-label"></label>
                <input asp-for="Pname" class="form-control mb-3" />
                <span asp-validation-for="Pname" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Pprice" class="control-label"></label>
                <input asp-for="Pprice" class="form-control mb-3" />
                <span asp-validation-for="Pprice" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Ptype" class="control-label"></label>
                <select asp-for="Ptype" asp-items="@(new SelectList(Model.PtypeList))" class="form-control mb-3">
                    <option value="">請選擇類型</option>
                </select>
                <span asp-validation-for="Ptype" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Pcategory" class="control-label"></label>
                <select asp-for="Pcategory" asp-items="@(new SelectList(Model.PcategoryList))" class="form-control mb-3">
                    <option value="">請選擇分類</option>
                </select>
                <span asp-validation-for="Pcategory" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Pdescription" class="control-label"></label>
                <input asp-for="Pdescription" class="form-control mb-3" />
                <span asp-validation-for="Pdescription" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Pinventory" class="control-label"></label>
                <input asp-for="Pinventory" class="form-control mb-3" />
                <span asp-validation-for="Pinventory" class="text-danger"></span>
            </div>
            <div class="form-group mt-4">
                <input type="submit" value="新增商品" class="btn btn-primary mb-3" />
            </div>
        </form>
    </div>
    <div class="col-md-8">
        <div class="form-group mt-4">
            <label for="photo">主圖片：</label>
            <input type="file" id="photo" name="photoPath" accept="image/*">
            <br>
            <img id="mainPreview" src="#" style="display:none; max-width:200px; margin-top:10px;">
        </div>
        <div class="form-group mt-4">
            <label for="photos">多張圖片：</label>
            <input type="file" id="photos" name="photos" multiple accept="image/*">
            <br>
            <div id="multiplePreview"></div>
        </div>
        <!-- 商品庫存動態新增區塊 -->
        <div class="form-group">
            <label class="control-label my-3">商品規格 (顏色 / 尺寸 / 庫存)</label>
            <div id="inventoryContainer">
                <!-- 預設第一組 -->
                <div class="inventory-group mb-2">
                    <input type="text" name="TproductInventories[0].Pcolor" class="form-control d-inline w-25" placeholder="顏色">
                    <input type="text" name="TproductInventories[0].Psize" class="form-control d-inline w-25" placeholder="尺寸">
                    <input type="number" name="TproductInventories[0].Pstock" class="form-control d-inline w-25" placeholder="庫存">
                    <button type="button" class="btn btn-success btn-sm" onclick="addInventory()">+</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div>
    <a asp-action="List">取消</a>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        let inventoryIndex = 1; // 控制陣列索引

        function addInventory() {
            let container = document.getElementById("inventoryContainer");

            let newInventory = document.createElement("div");
            newInventory.classList.add("inventory-group", "mb-2");
            newInventory.innerHTML = `
                <input type="text" name="TproductInventories[${inventoryIndex}].Pcolor" class="form-control d-inline w-25" placeholder="顏色">
                <input type="text" name="TproductInventories[${inventoryIndex}].Psize" class="form-control d-inline w-25" placeholder="尺寸">
                <input type="number" name="TproductInventories[${inventoryIndex}].Pstock" class="form-control d-inline w-25" placeholder="庫存">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeInventory(this)">-</button>
            `;

            container.appendChild(newInventory);
            inventoryIndex++; // 增加索引值
        }

        function removeInventory(button) {
            button.parentElement.remove();
        }
        document.getElementById("photo").addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function () {
                    const output = document.getElementById('mainPreview');
                    output.src = reader.result;
                    output.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });

        document.getElementById("photos").addEventListener("change", function (e) {
            const files = e.target.files;
            const previewDiv = document.getElementById("multiplePreview");
            previewDiv.innerHTML = ""; // 清空舊的預覽圖

            for (const file of files) {
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const img = document.createElement("img");
                        img.src = event.target.result;
                        img.style.maxWidth = "100px";
                        img.style.margin = "5px";
                        previewDiv.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                }
            }
        });
    </script>

}
